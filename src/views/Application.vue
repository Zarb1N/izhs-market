<template>
  <div class="application">
    <div class="application__header">
      <img
        class="application__back-btn"
        src="../assets/icons/arrow-left--black.svg"
        @click="$router.push(`/house/${$route.params.id}/preview/prices`)"
      />
      <div class="application__title title--primary">
        –ó–∞—è–≤–∫–∞ –Ω–∞ {{ house.name }}
      </div>
    </div>
    <div class="application__body">
      <Card>
        <div class="application__main-info">
          <div class="application__main-text-info">
            <div class="application__subtitle">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏</div>
            <div class="application__builders">
              <div
                class="application__builder"
                v-for="(key, index) in Object.keys(builders)"
                :key="index"
              >
                <img
                  class="application__builder-logo"
                  :src="builders[key][0].builder_info.image && builders[key][0].builder_info.image.url"
                />
                <div class="application__builder-name">
                  {{ builders[key][0].builder_info.name }}
                </div>
              </div>
            </div>
          </div>
          <img
            class="application__main-info-image"
          />
        </div>
        <div class="application__divider--horizontal"></div>
        <div class="application__what-is-next">
          <div class="application__subtitle">–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –¥–∞–ª—å—à–µ?</div>
          <ul class="application__bulleted-list">
            <li>
              <div>
                –ü–æ–æ–±—â–∞–µ—Ç–µ—Å—å –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞
                <img
                  src="../assets/icons/question-mark-in-circle.svg"
                  @click="(e) => showPopupHint(e, '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –¥—Ä—É–≥–∏–µ –æ–±—ä–µ–∫—Ç—ã –ø–æ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫—É, —Å—Ä–∞–≤–Ω–∏—Ç–µ —Å–º–µ—Ç—ã –∏ —Ä–µ—à–∏—Ç–µ, —Å –∫–µ–º –±—ã–ª–æ –ø—Ä–∏—è—Ç–Ω–µ–µ –æ–±—â–∞—Ç—å—Å—è üòâ')"
                >
              </div>
            </li>
            <li><div>–ù–∞—á–Ω–µ—Ç–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ </div></li>
            <li>–°–º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è <span class="underline-dashed">–ò–ñ–° Genius</span></li>
          </ul>
        </div>
      </Card>
      <Card>
        <div class="application__contacts">
          <div class="application__subtitle">–°–≤—è–∑–∞—Ç—å—Å—è –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞—Ö</div>
          <div class="application__contact">
            <img
              class="application__contact-image"
              :src="generalStore.getImageURL('telegram.svg')"
            />
            <div class="application__contact-name">–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram</div>
          </div>
          <div class="application__contact">
            <img
              class="application__contact-image"
              :src="generalStore.getImageURL('whatsapp.svg')"
            />
            <div class="application__contact-name">–ù–∞–ø–∏—Å–∞—Ç—å –≤ Whatsapp</div>
          </div>
        </div>
        <div class="application__divider--horizontal"></div>
        <div class="application__questions">
          <div class="application__subtitle">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã</div>
          <div class="application__description">–ù–∞—á–Ω–∏—Ç–µ –∑–≤–æ–Ω–æ–∫ —Å –æ—Ç–≤–µ—Ç–æ–≤ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞ <br/> –Ω–∞ –≤–∞–∂–Ω—ã–µ –¥–ª—è –≤–∞—Å –≤–æ–ø—Ä–æ—Å—ã</div>
          <div class="application__questions-items">
            <div
              class="application__questions-item"
              :class="question.selected ? 'application__questions-item--selected' : 'application__questions-item--unselected'"
              v-for="(question, index) in questions"
              :key="index"
              @click="question.selected = !question.selected"
            >{{question.text}}</div>
          </div>
        </div>
      </Card>
      <Card
        color="gray"
        style="box-shadow: 4px 6px 0px #000000;"
      >
        <div class="application__payment-conditions">
          <div class="application__subtitle">–£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã</div>
          <div class="application__description">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –æ–ø–ª–∞—á–∏–≤–∞–µ—é—Ç—Å—è –¥–æ –ø–æ—Å—Ç–∞–≤–∫–∏, —Ä–∞–±–æ—Ç—ã –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–∏–µ–º–∫–∏</div>
        </div>
        <div class="application__loyality-benefits">
          <div class="application__subtitle">–õ–æ—è–ª—å–Ω–æ—Å—Ç—å –ò–ñ–° CLUB</div>
          <div class="application__cashback-items">
            <div
              class="application__cashback-item"
              v-for="(item, index) in cashback"
              :key="index"
            >
              <div class="application__cashback-item-description">
                <div class="application__cashback-item-name">{{item.name}}</div>
                <img
                  class="application__cashback-item-hint"
                  :src="generalStore.getImageURL('icons/question-mark-in-circle.svg')"
                  v-if="item.description"
                  @click="(e) => showPopupHint(e, item.description)"
                />
              </div>
              <div class="application__cashback-item-price ruble-character">{{generalStore.formatNumber(item.cashback)}}</div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="application__summary-economy">
            <div class="application__summary-economy-text">–í—ã —ç–∫–æ–Ω–æ–º–∏—Ç–µ</div>
            <div class="application__summary-economy-money ruble-character">{{cashback[0] && generalStore.formatNumber(cashback.map( (item: {[key: string]: any}) => item.cashback).reduce( (acc, item) => acc += item) * (-1))}}</div>
          </div>
        </div>
      </Card>
    </div>
    <div class="application__bottom-elements">
      <input
        class="application__input-telephone-number"
        placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
        v-model="phoneNumber"
      />
      <div
        class="application__create-application-btn"
        @click="sendAnApplication()"
      >–û—Ç–ø—Ä–∞–≤–∏—Ç—å</div>
    </div>

    <PopupHint
      v-show="isHint"
      tabindex="0"
      ref="popupHint"
      :style="{
        'top': `${clickCoordinates.y}px`,
        'left': `${clickCoordinates.x}px`,
        'transform': `translate(${clickCoordinates.x < windowWidth / 2 ? '0, -100%' : '-100%, -100%'})`,
        'width': '100%',
        'max-width': '45%'
      }"
      @blur="isHint = false"
    >
      <div v-html="hintText"></div>
    </PopupHint>

  </div>
</template>

<script lang="ts">
import { useGeneralStore } from "@/stores/general";
import { defineComponent } from "@vue/runtime-core";
import ContentCard from "../components/ContentCard.vue";
import PopupHint from "../components/PopupHint.vue";

export default defineComponent({
  props: [
    'house',
    'builders',
    'cashback'
  ],
  data: () => ({
    generalStore: useGeneralStore(),
    hintText: '' as string,
    isHint: false,
    clickCoordinates: {x: 0, y: 0},
    phoneNumber: '' as number | string,
    questions: [
      {
        text: '–ï—Å—Ç—å –ª–∏ –æ–ø–ª–∞—Ç–∞ –ø–æ —Ñ–∞–∫—Ç—É?',
        selected: false
      },
      {
        text: '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –≤—Å—ë',
        selected: false
      },
      {
        text: '–ú–æ–∂–Ω–æ –ª–∏ –∫—É–ø–∏—Ç—å –¥–æ–º –ø–æ —Ü–µ–Ω–µ –∏–∑ –ò—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω?',
        selected: false
      },
      {
        text: '–ü–æ–∫–∞–∂–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—Ç –ø–æ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫—É',
        selected: false
      },
    ]
  }),
  methods: {
    showPopupHint(event : any, text: string) {
      this.hintText = text
      event.preventDefault()
      this.clickCoordinates = {
        x: event.x,
        y: event.y
      }
      this.$nextTick( () => {
        // @ts-ignore
        this.$refs.popupHint.$el.focus()
      })
      this.isHint = true
    },
    async sendAnApplication() {
      await fetch(`${this.generalStore.server}/applicationshouses`, {
        method: 'PUT',
        headers: {'Content-type': 'application/json'},
        body: JSON.stringify({
          house_name: this.house.name,
          phone_number: this.phoneNumber,
          questions: this.questions.filter(question => question.selected).map(question => question.text),
          cashbacks: this.cashback,
          promocodes: [
            /*
            {
              name: "string",
              description: "string"
            }
            */
          ]
        })
      })
      const res = await fetch(`${this.generalStore.server}/states/${this.generalStore.deviceId}`, {
        method: 'PATCH',
        headers: {'Content-type': 'application/json'},
        body: JSON.stringify({
          device_id: this.generalStore.deviceId,
          applications_houses_id: Number(this.$route.params.id)
        })
      })
      const data = await res.json()
      this.generalStore.deviceState = data
      this.$router.push(`/my-project/house/${this.generalStore.deviceState.applications_houses_id}`)
    },
  },
  mounted() {
  },
  computed: {
    windowWidth() {
      return window.innerWidth
    }
  },
  components: {
    Card: ContentCard,
    PopupHint
},
});
</script>

<style scoped>
.application {
  min-height: 100%;
  display: grid;
  grid-template-rows: min-content auto min-content;
}
.application__header {
  width: 100%;
  background: linear-gradient(273.3deg, #82b9f0 0%, #96c7f9 100%);
  padding: 20px 14px 15px 14px;
  display: flex;
  gap: 10px;
}
.application__back-btn {
  width: 32px;
  height: 32px;
}
.application__body {
  padding: 30px 14px calc(30px + 113px) 14px;
  display: flex;
  flex-direction: column;
  gap: 14px;
  min-height: 100%;
}
.application__subtitle {
  font-weight: 700;
  font-size: 12px;
  line-height: 15px;
  letter-spacing: 1px;
  text-transform: uppercase;
}
.application__divider--horizontal {
  margin: 20px -20px;
  height: 1px;
  background: #EDECF2;
}

.application__main-info {
  min-height: 73px;
  display: grid;
  grid-template-columns: auto 126px;
  gap: 14px;
}
.application__main-text-info {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.application__builders {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.application__builder {
  display: flex;
  gap: 5px;
  align-items: center;
}
.application__builder-logo {
  height: 21px;
  width: 21px;
}
.application__main-info-image {
  max-width: 100%;
  max-height: 73px;
  align-self: center;
  justify-self: center;
  border-radius: 15px;
}
.application__what-is-next {
  display: flex;
  flex-direction: column;
  gap: 7px;
}
.application__bulleted-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.application__bulleted-list > li > div{
  display: flex;
  align-items: center;
  gap: 3px;
}
.application__contacts {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.application__contact {
  display: flex;
  align-items: center;
  gap: 8px;
}
.application__questions-items {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.application__questions > .application__description {
  margin-top: 5px;
  margin-bottom: 15px;
}
.application__questions-item {
  height: 25px;
  display: flex;
  align-items: center;
  padding: 6px;
  font-weight: 400;
  font-size: 10px;
  line-height: 13px;
  border-radius: 8px;
  transition: all .3s;
}
.application__questions-item--selected {
  background: #C79081;
  border: 1px solid #C79081;
}
.application__questions-item--unselected {
  background: white;
  border: 1px solid #F1D6CE;
}
.application__payment-conditions {
  margin-bottom: 15px;
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.application__loyality-benefits {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.application__cashback-items {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.application__cashback-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.application__cashback-item-description {
  gap: 2px;
}
.application__cashback-item-name {
  font-weight: 400;
  font-size: 12px;
  line-height: 140%;
  display: inline;
}
.application__cashback-item-hint {
  display: inline;
  position: relative;
  margin-bottom: -3px;
  margin-left: 2px;
}
.application__cashback-item-price {
  font-weight: 400;
  font-size: 12px;
  line-height: 140%;
  color: #AA2020;
  white-space: nowrap;
}
.divider {
  height: 1px;
  background: #B9B7C0;
  margin: 0px -20px;
}
.application__summary-economy {
  display: flex;
  justify-content: space-between;
}
.application__summary-economy-text {
  font-weight: 700;
  font-size: 12px;
  line-height: 15px;
}
.application__summary-economy-money {
  font-weight: 700;
  font-size: 16px;
  line-height: 20px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  color: #30967E;
}
.application__bottom-elements {
  width: 100%;
  align-self: flex-end;
  position: fixed;
  bottom: 0;
}
.application__input-telephone-number {
  height: 57px;
  border: none;
  text-align: center;
  width: 100%;
  border-top: 1px solid #B5BFC9;
}
.application__input-telephone-number::placeholder {
  font-weight: 400;
  font-size: 12px;
  line-height: 140%;
  color: #A7AFB8;
}
.application__create-application-btn {
  margin-left: -14px;
  margin-right: -14px;
  height: calc(20px + 18px * 2);
  background: #439A86;
  font-weight: 700;
  font-size: 16px;
  line-height: 20px;
  text-align: center;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  color: #151918;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  bottom: 0;
}
</style>